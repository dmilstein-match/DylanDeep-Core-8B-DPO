[1mdiff --git a/debug_pipeline.sh b/debug_pipeline.sh[m
[1mindex be1b100..efe07f4 100755[m
[1m--- a/debug_pipeline.sh[m
[1m+++ b/debug_pipeline.sh[m
[36m@@ -1,229 +1,229 @@[m
[31m-#!/bin/bash[m
[31m-set +e  # Don't exit on error, we want to see all issues[m
[31m-[m
[31m-echo "================================================================================"[m
[31m-echo "Pipeline Diagnostics - Checking Each Step"[m
[31m-echo "================================================================================"[m
[31m-echo ""[m
[31m-[m
[31m-# Color codes[m
[31m-RED='\033[0;31m'[m
[31m-GREEN='\033[0;32m'[m
[31m-YELLOW='\033[1;33m'[m
[31m-NC='\033[0m'[m
[31m-[m
[31m-ERRORS=0[m
[31m-[m
[31m-# Check 1: Data directory exists[m
[31m-echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"[m
[31m-echo "Step 1: Check data directory"[m
[31m-echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"[m
[31m-if [ -d "data" ]; then[m
[31m-    echo -e "${GREEN}âœ“ data/ directory exists${NC}"[m
[31m-    ls -lh data/ 2>/dev/null || echo "  (empty)"[m
[31m-else[m
[31m-    echo -e "${RED}âœ— data/ directory missing${NC}"[m
[31m-    echo "  Creating data/ directory..."[m
[31m-    mkdir -p data[m
[31m-    ERRORS=$((ERRORS+1))[m
[31m-fi[m
[31m-echo ""[m
[31m-[m
[31m-# Check 2: GSM8K training data[m
[31m-echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"[m
[31m-echo "Step 2: Check GSM8K training data"[m
[31m-echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"[m
[31m-if [ -f "data/gsm8k_train.jsonl" ]; then[m
[31m-    COUNT=$(wc -l < data/gsm8k_train.jsonl)[m
[31m-    echo -e "${GREEN}âœ“ data/gsm8k_train.jsonl exists (${COUNT} examples)${NC}"[m
[31m-else[m
[31m-    echo -e "${RED}âœ— data/gsm8k_train.jsonl missing${NC}"[m
[31m-    echo "  Run: python download_gsm8k.py"[m
[31m-    ERRORS=$((ERRORS+1))[m
[31m-fi[m
[31m-echo ""[m
[31m-[m
[31m-# Check 3: Model checkpoint[m
[31m-echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"[m
[31m-echo "Step 3: Check base model checkpoint"[m
[31m-echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"[m
[31m-if [ -d "checkpoints/abel_sft_merged" ]; then[m
[31m-    echo -e "${GREEN}âœ“ checkpoints/abel_sft_merged/ exists${NC}"[m
[31m-[m
[31m-    # Check for config.json[m
[31m-    if [ -f "checkpoints/abel_sft_merged/config.json" ]; then[m
[31m-        echo -e "${GREEN}  âœ“ config.json found${NC}"[m
[31m-[m
[31m-        # Check for head_dim[m
[31m-        HAS_HEAD_DIM=$(python3 -c "[m
[31m-import json[m
[31m-with open('checkpoints/abel_sft_merged/config.json') as f:[m
[31m-    config = json.load(f)[m
[31m-print('head_dim' in config)[m
[31m-" 2>/dev/null)[m
[31m-[m
[31m-        if [ "$HAS_HEAD_DIM" = "True" ]; then[m
[31m-            echo -e "${GREEN}  âœ“ head_dim configured for vLLM${NC}"[m
[31m-        else[m
[31m-            echo -e "${YELLOW}  âš  head_dim missing (vLLM may fail)${NC}"[m
[31m-            echo "  Fix: Add head_dim to config.json"[m
[31m-        fi[m
[31m-    else[m
[31m-        echo -e "${RED}  âœ— config.json missing${NC}"[m
[31m-        ERRORS=$((ERRORS+1))[m
[31m-    fi[m
[31m-else[m
[31m-    echo -e "${RED}âœ— checkpoints/abel_sft_merged/ missing${NC}"[m
[31m-    echo "  Need to create merged SFT checkpoint first"[m
[31m-    ERRORS=$((ERRORS+1))[m
[31m-fi[m
[31m-echo ""[m
[31m-[m
[31m-# Check 4: Rollout data[m
[31m-echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"[m
[31m-echo "Step 4: Check rollout data"[m
[31m-echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"[m
[31m-if [ -f "data/abel_regime_w_rollouts.jsonl" ]; then[m
[31m-    COUNT=$(wc -l < data/abel_regime_w_rollouts.jsonl)[m
[31m-    echo -e "${GREEN}âœ“ data/abel_regime_w_rollouts.jsonl exists (${COUNT} rollouts)${NC}"[m
[31m-[m
[31m-    # Validate rollout structure[m
[31m-    python3 << 'PYEOF'[m
[31m-import json[m
[31m-import sys[m
[31m-[m
[31m-try:[m
[31m-    with open('data/abel_regime_w_rollouts.jsonl', 'r') as f:[m
[31m-        first_line = f.readline()[m
[31m-        if not first_line:[m
[31m-            print("\033[0;31m  âœ— Rollout file is empty\033[0m")[m
[31m-            sys.exit(1)[m
[31m-[m
[31m-        rollout = json.loads(first_line)[m
[31m-[m
[31m-        # Check structure[m
[31m-        required = ['question', 'gold_answer', 'trajectories'][m
[31m-        missing = [k for k in required if k not in rollout][m
[31m-        if missing:[m
[31m-            print(f"\033[0;31m  âœ— Missing keys: {missing}\033[0m")[m
[31m-            sys.exit(1)[m
[31m-[m
[31m-        # Check trajectories[m
[31m-        if not rollout['trajectories']:[m
[31m-            print("\033[0;31m  âœ— No trajectories in first rollout\033[0m")[m
[31m-            sys.exit(1)[m
[31m-[m
[31m-        traj = rollout['trajectories'][0][m
[31m-        traj_required = ['full_text', 'answer', 'reward', 'correct', 'arm_name'][m
[31m-        traj_missing = [k for k in traj_required if k not in traj][m
[31m-[m
[31m-        if traj_missing:[m
[31m-            print(f"\033[0;31m  âœ— Trajectories missing: {traj_missing}\033[0m")[m
[31m-            if 'arm_name' in traj_missing:[m
[31m-                print("\033[0;31m  âœ— CRITICAL: No arm_name field - rollouts are OLD format!\033[0m")[m
[31m-                print("\033[0;31m  âœ— Must regenerate rollouts with updated script\033[0m")[m
[31m-            sys.exit(1)[m
[31m-[m
[31m-        print(f"\033[0;32m  âœ“ Rollout structure valid\033[0m")[m
[31m-        print(f"\033[0;32m  âœ“ First trajectory arm: {traj['arm_name']}\033[0m")[m
[31m-        print(f"\033[0;32m  âœ“ Trajectories per rollout: {len(rollout['trajectories'])}\033[0m")[m
[31m-[m
[31m-        # Check reward differentiation[m
[31m-        rewards = [t['reward'] for t in rollout['trajectories'] if t['correct']][m
[31m-        if rewards:[m
[31m-            if len(set(rewards)) == 1:[m
[31m-                print(f"\033[1;33m  âš  All rewards identical: {rewards[0]:.4f}\033[0m")[m
[31m-                print(f"\033[1;33m  âš  May not generate coherence pairs\033[0m")[m
[31m-            else:[m
[31m-                min_r = min(rewards)[m
[31m-                max_r = max(rewards)[m
[31m-                print(f"\033[0;32m  âœ“ Reward range: {min_r:.4f} to {max_r:.4f}\033[0m")[m
[31m-[m
[31m-except Exception as e:[m
[31m-    print(f"\033[0;31m  âœ— Error reading rollouts: {e}\033[0m")[m
[31m-    sys.exit(1)[m
[31m-PYEOF[m
[31m-[m
[31m-    if [ $? -ne 0 ]; then[m
[31m-        ERRORS=$((ERRORS+1))[m
[31m-    fi[m
[31m-else[m
[31m-    echo -e "${RED}âœ— data/abel_regime_w_rollouts.jsonl missing${NC}"[m
[31m-    echo "  Run: python src/rl_training/collect_rollouts_abel_vllm.py --n_samples 500"[m
[31m-    ERRORS=$((ERRORS+1))[m
[31m-fi[m
[31m-echo ""[m
[31m-[m
[31m-# Check 5: Preference pairs[m
[31m-echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"[m
[31m-echo "Step 5: Check preference pairs"[m
[31m-echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"[m
[31m-if [ -f "data/abel_coherence_preferences.jsonl" ]; then[m
[31m-    COUNT=$(wc -l < data/abel_coherence_preferences.jsonl)[m
[31m-    echo -e "${GREEN}âœ“ data/abel_coherence_preferences.jsonl exists (${COUNT} pairs)${NC}"[m
[31m-[m
[31m-    # Count pair types[m
[31m-    python3 << 'PYEOF'[m
[31m-import json[m
[31m-[m
[31m-try:[m
[31m-    with open('data/abel_coherence_preferences.jsonl', 'r') as f:[m
[31m-        prefs = [json.loads(line) for line in f][m
[31m-[m
[31m-    correctness = sum(1 for p in prefs if p.get('pair_type') == 'correctness')[m
[31m-    coherence = sum(1 for p in prefs if p.get('pair_type') == 'coherence')[m
[31m-    total = len(prefs)[m
[31m-[m
[31m-    print(f"\033[0;32m  âœ“ Total pairs: {total}\033[0m")[m
[31m-    print(f"\033[0;32m  âœ“ Correctness pairs: {correctness} ({100*correctness/total:.1f}%)\033[0m")[m
[31m-[m
[31m-    if coherence == 0:[m
[31m-        print(f"\033[0;31m  âœ— Coherence pairs: {coherence} (0%)\033[0m")[m
[31m-        print(f"\033[0;31m  âœ— CRITICAL: No coherence pairs generated!\033[0m")[m
[31m-        print(f"\033[0;31m  âœ— Check if rollouts have reward differentiation\033[0m")[m
[31m-        import sys[m
[31m-        sys.exit(1)[m
[31m-    else:[m
[31m-        print(f"\033[0;32m  âœ“ Coherence pairs: {coherence} ({100*coherence/total:.1f}%)\033[0m")[m
[31m-[m
[31m-except Exception as e:[m
[31m-    print(f"\033[0;31m  âœ— Error reading preferences: {e}\033[0m")[m
[31m-    import sys[m
[31m-    sys.exit(1)[m
[31m-PYEOF[m
[31m-[m
[31m-    if [ $? -ne 0 ]; then[m
[31m-        ERRORS=$((ERRORS+1))[m
[31m-    fi[m
[31m-else[m
[31m-    echo -e "${RED}âœ— data/abel_coherence_preferences.jsonl missing${NC}"[m
[31m-    echo "  Run: python src/rl_training/build_preferences_abel.py"[m
[31m-    ERRORS=$((ERRORS+1))[m
[31m-fi[m
[31m-echo ""[m
[31m-[m
[31m-# Summary[m
[31m-echo "================================================================================"[m
[31m-if [ $ERRORS -eq 0 ]; then[m
[31m-    echo -e "${GREEN}âœ“ All checks passed! Ready for DPO training.${NC}"[m
[31m-    echo ""[m
[31m-    echo "Next step:"[m
[31m-    echo "  accelerate launch src/rl_training/train_dpo_coherence.py"[m
[31m-else[m
[31m-    echo -e "${RED}âœ— Found $ERRORS issue(s) - fix them before training${NC}"[m
[31m-    echo ""[m
[31m-    echo "Quick fix commands:"[m
[31m-    echo ""[m
[31m-    echo "# If missing training data:"[m
[31m-    echo "  python download_gsm8k.py"[m
[31m-    echo ""[m
[31m-    echo "# If missing/old rollouts:"[m
[31m-    echo "  python src/rl_training/collect_rollouts_abel_vllm.py --n_samples 500"[m
[31m-    echo ""[m
[31m-    echo "# If missing preferences:"[m
[31m-    echo "  python src/rl_training/build_preferences_abel.py"[m
[31m-fi[m
[31m-echo "================================================================================"[m
[31m-echo ""[m
[31m-[m
[31m-exit $ERRORS[m
[32m+[m[32m#!/bin/bash[m
[32m+[m[32mset +e  # Don't exit on error, we want to see all issues[m
[32m+[m
[32m+[m[32mecho "================================================================================"[m
[32m+[m[32mecho "Pipeline Diagnostics - Checking Each Step"[m
[32m+[m[32mecho "================================================================================"[m
[32m+[m[32mecho ""[m
[32m+[m
[32m+[m[32m# Color codes[m
[32m+[m[32mRED='\033[0;31m'[m
[32m+[m[32mGREEN='\033[0;32m'[m
[32m+[m[32mYELLOW='\033[1;33m'[m
[32m+[m[32mNC='\033[0m'[m
[32m+[m
[32m+[m[32mERRORS=0[m
[32m+[m
[32m+[m[32m# Check 1: Data directory exists[m
[32m+[m[32mecho "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"[m
[32m+[m[32mecho "Step 1: Check data directory"[m
[32m+[m[32mecho "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"[m
[32m+[m[32mif [ -d "data" ]; then[m
[32m+[m[32m    echo -e "${GREEN}âœ“ data/ directory exists${NC}"[m
[32m+[m[32m    ls -lh data/ 2>/dev/null || echo "  (empty)"[m
[32m+[m[32melse[m
[32m+[m[32m    echo -e "${RED}âœ— data/ directory missing${NC}"[m
[32m+[m[32m    echo "  Creating data/ directory..."[m
[32m+[m[32m    mkdir -p data[m
[32m+[m[32m    ERRORS=$((ERRORS+1))[m
[32m+[m[32mfi[m
[32m+[m[32mecho ""[m
[32m+[m
[32m+[m[32m# Check 2: GSM8K training data[m
[32m+[m[32mecho "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"[m
[32m+[m[32mecho "Step 2: Check GSM8K training data"[m
[32m+[m[32mecho "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"[m
[32m+[m[32mif [ -f "data/gsm8k_train.jsonl" ]; then[m
[32m+[m[32m    COUNT=$(wc -l < data/gsm8k_train.jsonl)[m
[32m+[m[32m    echo -e "${GREEN}âœ“ data/gsm8k_train.jsonl exists (${COUNT} examples)${NC}"[m
[32m+[m[32melse[m
[32m+[m[32m    echo -e "${RED}âœ— data/gsm8k_train.jsonl missing${NC}"[m
[32m+[m[32m    echo "  Run: python download_gsm8k.py"[m
[32m+[m[32m    ERRORS=$((ERRORS+1))[m
[32m+[m[32mfi[m
[32m+[m[32mecho ""[m
[32m+[m
[32m+[m[32m# Check 3: Model checkpoint[m
[32m+[m[32mecho "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"[m
[32m+[m[32mecho "Step 3: Check base model checkpoint"[m
[32m+[m[32mecho "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"[m
[32m+[m[32mif [ -d "checkpoints/abel_sft_merged" ]; then[m
[32m+[m[32m    echo -e "${GREEN}âœ“ checkpoints/abel_sft_merged/ exists${NC}"[m
[32m+[m
[32m+[m[32m    # Check for config.json[m
[32m+[m[32m    if [ -f "checkpoints/abel_sft_merged/config.json" ]; then[m
[32m+[m[32m        echo -e "${GREEN}  âœ“ config.json found${NC}"[m
[32m+[m
[32m+[m[32m        # Check for head_dim[m
[32m+[m[32m        HAS_HEAD_DIM=$(python3 -c "[m
[32m+[m[32mimport json[m
[32m+[m[32mwith open('checkpoints/abel_sft_merged/config.json') as f:[m
[32m+[m[32m    config = json.load(f)[m
[32m+[m[32mprint('head_dim' in config)[m
[32m+[m[32m" 2>/dev/null)[m
[32m+[m
[32m+[m[32m        if [ "$HAS_HEAD_DIM" = "True" ]; then[m
[32m+[m[32m            echo -e "${GREEN}  âœ“ head_dim configured for vLLM${NC}"[m
[32m+[m[32m        else[m
[32m+[m[32m            echo -e "${YELLOW}  âš  head_dim missing (vLLM may fail)${NC}"[m
[32m+[m[32m            echo "  Fix: Add head_dim to config.json"[m
[32m+[m[32m        fi[m
[32m+[m[32m    else[m
[32m+[m[32m        echo -e "${RED}  âœ— config.json missing${NC}"[m
[32m+[m[32m        ERRORS=$((ERRORS+1))[m
[32m+[m[32m    fi[m
[32m+[m[32melse[m
[32m+[m[32m    echo -e "${RED}âœ— checkpoints/abel_sft_merged/ missing${NC}"[m
[32m+[m[32m    echo "  Need to create merged SFT checkpoint first"[m
[32m+[m[32m    ERRORS=$((ERRORS+1))[m
[32m+[m[32mfi[m
[32m+[m[32mecho ""[m
[32m+[m
[32m+[m[32m# Check 4: Rollout data[m
[32m+[m[32mecho "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"[m
[32m+[m[32mecho "Step 4: Check rollout data"[m
[32m+[m[32mecho "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"[m
[32m+[m[32mif [ -f "data/abel_regime_w_rollouts.jsonl" ]; then[m
[32m+[m[32m    COUNT=$(wc -l < data/abel_regime_w_rollouts.jsonl)[m
[32m+[m[32m    echo -e "${GREEN}âœ“ data/abel_regime_w_rollouts.jsonl exists (${COUNT} rollouts)${NC}"[m
[32m+[m
[32m+[m[32m    # Validate rollout structure[m
[32m+[m[32m    python3 << 'PYEOF'[m
[32m+[m[32mimport json[m
[32m+[m[32mimport sys[m
[32m+[m
[32m+[m[32mtry:[m
[32m+[m[32m    with open('data/abel_regime_w_rollouts.jsonl', 'r') as f:[m
[32m+[m[32m        first_line = f.readline()[m
[32m+[m[32m        if not first_line:[m
[32m+[m[32m            print("\033[0;31m  âœ— Rollout file is empty\033[0m")[m
[32m+[m[32m            sys.exit(1)[m
[32m+[m
[32m+[m[32m        rollout = json.loads(first_line)[m
[32m+[m
[32m+[m[32m        # Check structure[m
[32m+[m[32m        required = ['question', 'gold_answer', 'trajectories'][m
[32m+[m[32m        missing = [k for k in required if k not in rollout][m
[32m+[m[32m        if missing:[m
[32m+[m[32m            print(f"\033[0;31m  âœ— Missing keys: {missing}\033[0m")[m
[32m+[m[32m            sys.exit(1)[m
[32m+[m
[32m+[m[32m        # Check trajectories[m
[32m+[m[32m        if not rollout['trajectories']:[m
[32m+[m[32m            print("\033[0;31m  âœ— No trajectories in first rollout\033[0m")[m
[32m+[m[32m            sys.exit(1)[m
[32m+[m
[32m+[m[32m        traj = rollout['trajectories'][0][m
[32m+[m[32m        traj_required = ['full_text', 'answer', 'reward', 'correct', 'arm_name'][m
[32m+[m[32m        traj_missing = [k for k in traj_required if k not in traj][m
[32m+[m
[32m+[m[32m        if traj_missing:[m
[32m+[m[32m            print(f"\033[0;31m  âœ— Trajectories missing: {traj_missing}\033[0m")[m
[32m+[m[32m            if 'arm_name' in traj_missing:[m
[32m+[m[32m                print("\033[0;31m  âœ— CRITICAL: No arm_name field - rollouts are OLD format!\033[0m")[m
[32m+[m[32m                print("\033[0;31m  âœ— Must regenerate rollouts with updated script\033[0m")[m
[32m+[m[32m            sys.exit(1)[m
[32m+[m
[32m+[m[32m        print(f"\033[0;32m  âœ“ Rollout structure valid\033[0m")[m
[32m+[m[32m        print(f"\033[0;32m  âœ“ First trajectory arm: {traj['arm_name']}\033[0m")[m
[32m+[m[32m        print(f"\033[0;32m  âœ“ Trajectories per rollout: {len(rollout['trajectories'])}\033[0m")[m
[32m+[m
[32m+[m[32m        # Check reward differentiation[m
[32m+[m[32m        rewards = [t['reward'] for t in rollout['trajectories'] if t['correct']][m
[32m+[m[32m        if rewards:[m
[32m+[m[32m            if len(set(rewards)) == 1:[m
[32m+[m[32m                print(f"\033[1;33m  âš  All rewards identical: {rewards[0]:.4f}\033[0m")[m
[32m+[m[32m                print(f"\033[1;33m  âš  May not generate coherence pairs\033[0m")[m
[32m+[m[32m            else:[m
[32m+[m[32m                min_r = min(rewards)[m
[32m+[m[32m                max_r = max(rewards)[m
[32m+[m[32m                print(f"\033[0;32m  âœ“ Reward range: {min_r:.4f} to {max_r:.4f}\033[0m")[m
[32m+[m
[32m+[m[32mexcept Exception as e:[m
[32m+[m[32m    print(f"\033[0;31m  âœ— Error reading rollouts: {e}\033[0m")[m
[32m+[m[32m    sys.exit(1)[m
[32m+[m[32mPYEOF[m
[32m+[m
[32m+[m[32m    if [ $? -ne 0 ]; then[m
[32m+[m[32m        ERRORS=$((ERRORS+1))[m
[32m+[m[32m    fi[m
[32m+[m[32melse[m
[32m+[m[32m    echo -e "${RED}âœ— data/abel_regime_w_rollouts.jsonl missing${NC}"[m
[32m+[m[32m    echo "  Run: python src/rl_training/collect_rollouts_abel_vllm.py --n_samples 500"[m
[32m+[m[32m    ERRORS=$((ERRORS+1))[m
[32m+[m[32mfi[m
[32m+[m[32mecho ""[m
[32m+[m
[32m+[m[32m# Check 5: Preference pairs[m
[32m+[m[32mecho "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"[m
[32m+[m[32mecho "Step 5: Check preference pairs"[m
[32m+[m[32mecho "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"[m
[32m+[m[32mif [ -f "data/abel_coherence_preferences.jsonl" ]; then[m
[32m+[m[32m    COUNT=$(wc -l < data/abel_coherence_preferences.jsonl)[m
[32m+[m[32m    echo -e "${GREEN}âœ“ data/abel_coherence_preferences.jsonl exists (${COUNT} pairs)${NC}"[m
[32m+[m
[32m+[m[32m    # Count pair types[m
[32m+[m[32m    python3 << 'PYEOF'[m
[32m+[m[32mimport json[m
[32m+[m
[32m+[m[32mtry:[m
[32m+[m[32m    with open('data/abel_coherence_preferences.jsonl', 'r') as f:[m
[32m+[m[32m        prefs = [json.loads(line) for line in f][m
[32m+[m
[32m+[m[32m    correctness = sum(1 for p in prefs if p.get('pair_type') == 'correctness')[m
[32m+[m[32m    coherence = sum(1 for p in prefs if p.get('pair_type') == 'coherence')[m
[32m+[m[32m    total = len(prefs)[m
[32m+[m
[32m+[m[32m    print(f"\033[0;32m  âœ“ Total pairs: {total}\033[0m")[m
[32m+[m[32m    print(f"\033[0;32m  âœ“ Correctness pairs: {correctness} ({100*correctness/total:.1f}%)\033[0m")[m
[32m+[m
[32m+[m[32m    if coherence == 0:[m
[32m+[m[32m        print(f"\033[0;31m  âœ— Coherence pairs: {coherence} (0%)\033[0m")[m
[32m+[m[32m        print(f"\033[0;31m  âœ— CRITICAL: No coherence pairs generated!\033[0m")[m
[32m+[m[32m        print(f"\033[0;31m  âœ— Check if rollouts have reward differentiation\033[0m")[m
[32m+[m[32m        import sys[m
[32m+[m[32m        sys.exit(1)[m
[32m+[m[32m    else:[m
[32m+[m[32m        print(f"\033[0;32m  âœ“ Coherence pairs: {coherence} ({100*coherence/total:.1f}%)\033[0m")[m
[32m+[m
[32m+[m[32mexcept Exception as e:[m
[32m+[m[32m    print(f"\033[0;31m  âœ— Error reading preferences: {e}\033[0m")[m
[32m+[m[32m    import sys[m
[32m+[m[32m    sys.exit(1)[m
[32m+[m[32mPYEOF[m
[32m+[m
[32m+[m[32m    if [ $? -ne 0 ]; then[m
[32m+[m[32m        ERRORS=$((ERRORS+1))[m
[32m+[m[32m    fi[m
[32m+[m[32melse[m
[32m+[m[32m    echo -e "${RED}âœ— data/abel_coherence_preferences.jsonl missing${NC}"[m
[32m+[m[32m    echo "  Run: python src/rl_training/build_preferences_abel.py"[m
[32m+[m[32m    ERRORS=$((ERRORS+1))[m
[32m+[m[32mfi[m
[32m+[m[32mecho ""[m
[32m+[m
[32m+[m[32m# Summary[m
[32m+[m[32mecho "================================================================================"[m
[32m+[m[32mif [ $ERRORS -eq 0 ]; then[m
[32m+[m[32m    echo -e "${GREEN}âœ“ All checks passed! Ready for DPO training.${NC}"[m
[32m+[m[32m    echo ""[m
[32m+[m[32m    echo "Next step:"[m
[32m+[m[32m    echo "  accelerate launch src/rl_training/train_dpo_coherence.py"[m
[32m+[m[32melse[m
[32m+[m[32m    echo -e "${RED}âœ— Found $ERRORS issue(s) - fix them before training${NC}"[m
[32m+[m[32m    echo ""[m
[32m+[m[32m    echo "Quick fix commands:"[m
[32m+[m[32m    echo ""[m
[32m+[m[32m    echo "# If missing training data:"[m
[32m+[m[32m    echo "  python download_gsm8k.py"[m
[32m+[m[32m    echo ""[m
[32m+[m[32m    echo "# If missing/old rollouts:"[m
[32m+[m[32m    echo "  python src/rl_training/collect_rollouts_abel_vllm.py --n_samples 500"[m
[32m+[m[32m    echo ""[m
[32m+[m[32m    echo "# If missing preferences:"[m
[32m+[m[32m    echo "  python src/rl_training/build_preferences_abel.py"[m
[32m+[m[32mfi[m
[32m+[m[32mecho "================================================================================"[m
[32m+[m[32mecho ""[m
[32m+[m
[32m+[m[32mexit $ERRORS[m
