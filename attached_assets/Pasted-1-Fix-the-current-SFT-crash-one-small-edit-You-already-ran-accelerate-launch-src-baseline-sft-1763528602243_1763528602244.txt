1️⃣ Fix the current SFT crash (one small edit)

You already ran:

accelerate launch src/baseline_sft/train_sft_abel.py


and hit:

AttributeError: 'list' object has no attribute 'endswith'


This is TRL’s add_eos_token trying to do .endswith() on a list. We’ll just tell SFTTrainer:

“we’re using a formatting_func, not a raw text field”

“do NOT auto-add EOS; we’ll handle EOS ourselves”

Step 1: edit the trainer call
cd ~/looper-math-platinum-8b
source .venv/bin/activate
nano src/baseline_sft/train_sft_abel.py


Find the SFTTrainer( call (around line 100–120). It probably looks something like:

trainer = SFTTrainer(
    model=model,
    tokenizer=tokenizer,
    train_dataset=train_ds,
    args=sft_config,
    formatting_func=format_gsm8k_abel,
)


Change it to:

trainer = SFTTrainer(
    model=model,
    tokenizer=tokenizer,
    train_dataset=train_ds,
    args=sft_config,
    formatting_func=format_gsm8k_abel,  # or whatever your function is named
    dataset_text_field=None,            # <-- important
    add_eos_token=False,                # <-- important
)


Save & exit:

Ctrl + O, Enter

Ctrl + X

Step 2: make sure formatting function adds EOS

In the same file, find your formatting function, something like:

def format_gsm8k_abel(example):
    # build text from question + answer
    ...
    return {"text": text}


Make sure it appends EOS itself. For example:

def format_gsm8k_abel(example):
    question = example["question"]
    answer = example["answer"]  # Abel-style GSM8K answer

    text = (
        "You are a careful math tutor. Solve step-by-step, "
        "then end with '#### final_answer'.\n\n"
        f"Problem:\n{question}\n\nSolution:\n{answer}"
    )

    eos = tokenizer.eos_token or ""
    if eos and not text.endswith(eos):
        text = text + eos

    return {"text": text}


If your function returns a list of texts instead of a single string, do:

def format_gsm8k_abel(example):
    texts = [...]  # however you build them

    eos = tokenizer.eos_token or ""
    if eos:
        texts = [t if t.endswith(eos) else t + eos for t in texts]

    return {"text": texts}


You don’t have to overthink the exact wording; the key is: each string you hand to TRL already ends with EOS so we can safely disable add_eos_token.